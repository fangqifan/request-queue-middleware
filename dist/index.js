!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("request-middleware-pipeline")):"function"==typeof define&&define.amd?define(["request-middleware-pipeline"],t):e["request-queue-middleware"]=t(e["request-middleware-pipeline"])}(this,function(e){"use strict";function t(){}function n(){n.init.call(this)}function r(e){return void 0===e._maxListeners?n.defaultMaxListeners:e._maxListeners}function i(e,t,n){if(t)e.call(n);else for(var r=e.length,i=v(e,r),o=0;o<r;++o)i[o].call(n)}function o(e,t,n,r){if(t)e.call(n,r);else for(var i=e.length,o=v(e,i),s=0;s<i;++s)o[s].call(n,r)}function s(e,t,n,r,i){if(t)e.call(n,r,i);else for(var o=e.length,s=v(e,o),u=0;u<o;++u)s[u].call(n,r,i)}function u(e,t,n,r,i,o){if(t)e.call(n,r,i,o);else for(var s=e.length,u=v(e,s),c=0;c<s;++c)u[c].call(n,r,i,o)}function c(e,t,n,r){if(t)e.apply(n,r);else for(var i=e.length,o=v(e,i),s=0;s<i;++s)o[s].apply(n,r)}function f(e,n,i,o){var s,u,c;if("function"!=typeof i)throw new TypeError('"listener" argument must be a function');if(u=e._events,u?(u.newListener&&(e.emit("newListener",n,i.listener?i.listener:i),u=e._events),c=u[n]):(u=e._events=new t,e._eventsCount=0),c){if("function"==typeof c?c=u[n]=o?[i,c]:[c,i]:o?c.unshift(i):c.push(i),!c.warned&&(s=r(e))&&s>0&&c.length>s){c.warned=!0;var f=new Error("Possible EventEmitter memory leak detected. "+c.length+" "+n+" listeners added. Use emitter.setMaxListeners() to increase limit");f.name="MaxListenersExceededWarning",f.emitter=e,f.type=n,f.count=c.length,l(f)}}else c=u[n]=i,++e._eventsCount;return e}function l(e){"function"==typeof console.warn?console.warn(e):console.log(e)}function a(e,t,n){function r(){e.removeListener(t,r),i||(i=!0,n.apply(e,arguments))}var i=!1;return r.listener=n,r}function h(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function p(e,t){for(var n=t,r=n+1,i=e.length;r<i;n+=1,r+=1)e[n]=e[r];e.pop()}function v(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}function y(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}function m(e){if(!(this instanceof m))return new m(e);E.call(this),e=e||{},this.concurrency=e.concurrency||1/0,this.timeout=e.timeout||0,this.autostart=e.autostart||!1,this.results=e.results||null,this.pending=0,this.session=0,this.running=!1,this.jobs=[],this.timers={}}function d(){for(var e in this.timers){var t=this.timers[e];delete this.timers[e],clearTimeout(t)}}function g(e){function t(e){r.end(e)}function n(i){r.removeListener("error",t),r.removeListener("end",n),e(i,this.results)}var r=this;this.on("error",t),this.on("end",n)}function b(e){this.session++,this.running=!1,this.emit("end",e)}function w(){var e=[].slice.call(arguments),t=!1;"boolean"==typeof e[0]&&(t=e.shift());var n=e[0];if(!n||"object"!=typeof n&&"function"!=typeof n)throw new Error("extendee must be an object");for(var r=e.slice(1),i=r.length,o=0;o<i;o++){var s=r[o];for(var u in s)if(s.hasOwnProperty(u)){var c=s[u];if(t&&_(c)){var f=Array.isArray(c)?[]:{};n[u]=w(!0,n[u]||f,c)}else n[u]=c}}return n}function _(e){return Array.isArray(e)||"[object Object]"=={}.toString.call(e)}var L=function(e,t){return t={exports:{}},e(t,t.exports),t.exports}(function(e){"function"==typeof Object.create?e.exports=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:e.exports=function(e,t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}});t.prototype=Object.create(null),n.EventEmitter=n,n.usingDomains=!1,n.prototype.domain=void 0,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.init=function(){this.domain=null,n.usingDomains&&(!(void 0).active||this instanceof(void 0).Domain||(this.domain=(void 0).active)),this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new t,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},n.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},n.prototype.getMaxListeners=function(){return r(this)},n.prototype.emit=function(e){var t,n,r,f,l,a,h,p="error"===e;if(a=this._events)p=p&&null==a.error;else if(!p)return!1;if(h=this.domain,p){if(t=arguments[1],!h){if(t instanceof Error)throw t;var v=new Error('Uncaught, unspecified "error" event. ('+t+")");throw v.context=t,v}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=h,t.domainThrown=!1,h.emit("error",t),!1}if(!(n=a[e]))return!1;var y="function"==typeof n;switch(r=arguments.length){case 1:i(n,y,this);break;case 2:o(n,y,this,arguments[1]);break;case 3:s(n,y,this,arguments[1],arguments[2]);break;case 4:u(n,y,this,arguments[1],arguments[2],arguments[3]);break;default:for(f=new Array(r-1),l=1;l<r;l++)f[l-1]=arguments[l];c(n,y,this,f)}return!0},n.prototype.addListener=function(e,t){return f(this,e,t,!1)},n.prototype.on=n.prototype.addListener,n.prototype.prependListener=function(e,t){return f(this,e,t,!0)},n.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,a(this,e,t)),this},n.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,a(this,e,t)),this},n.prototype.removeListener=function(e,n){var r,i,o,s,u;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if(!(i=this._events))return this;if(!(r=i[e]))return this;if(r===n||r.listener&&r.listener===n)0==--this._eventsCount?this._events=new t:(delete i[e],i.removeListener&&this.emit("removeListener",e,r.listener||n));else if("function"!=typeof r){for(o=-1,s=r.length;s-- >0;)if(r[s]===n||r[s].listener&&r[s].listener===n){u=r[s].listener,o=s;break}if(o<0)return this;if(1===r.length){if(r[0]=void 0,0==--this._eventsCount)return this._events=new t,this;delete i[e]}else p(r,o);i.removeListener&&this.emit("removeListener",e,u||n)}return this},n.prototype.removeAllListeners=function(e){var n,r;if(!(r=this._events))return this;if(!r.removeListener)return 0===arguments.length?(this._events=new t,this._eventsCount=0):r[e]&&(0==--this._eventsCount?this._events=new t:delete r[e]),this;if(0===arguments.length){for(var i,o=Object.keys(r),s=0;s<o.length;++s)"removeListener"!==(i=o[s])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=new t,this._eventsCount=0,this}if("function"==typeof(n=r[e]))this.removeListener(e,n);else if(n)do{this.removeListener(e,n[n.length-1])}while(n[0]);return this},n.prototype.listeners=function(e){var t,n,r=this._events;return r?(t=r[e],n=t?"function"==typeof t?[t.listener||t]:y(t):[]):n=[],n},n.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):h.call(e,t)},n.prototype.listenerCount=h,n.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var j=Object.freeze({default:n,EventEmitter:n}),x=j&&n||j,E=x.EventEmitter,O=m;L(m,E),["pop","shift","indexOf","lastIndexOf"].forEach(function(e){m.prototype[e]=function(){return Array.prototype[e].apply(this.jobs,arguments)}}),m.prototype.slice=function(e,t){return this.jobs=this.jobs.slice(e,t),this},m.prototype.reverse=function(){return this.jobs.reverse(),this},["push","unshift","splice"].forEach(function(e){m.prototype[e]=function(){var t=Array.prototype[e].apply(this.jobs,arguments);return this.autostart&&this.start(),t}}),Object.defineProperty(m.prototype,"length",{get:function(){return this.pending+this.jobs.length}}),m.prototype.start=function(e){function t(e,t){i&&n.session===o&&(i=!1,n.pending--,null!==s&&(delete n.timers[s],clearTimeout(s)),e?n.emit("error",e,r):!1===u&&(null!==c&&(n.results[c]=Array.prototype.slice.call(arguments,1)),n.emit("success",t,r)),n.session===o&&(0===n.pending&&0===n.jobs.length?b.call(n):n.running&&n.start()))}if(e&&g.call(this,e),this.running=!0,!(this.pending>=this.concurrency)){if(0===this.jobs.length)return void(0===this.pending&&b.call(this));var n=this,r=this.jobs.shift(),i=!0,o=this.session,s=null,u=!1,c=null;this.timeout&&(s=setTimeout(function(){u=!0,n.listeners("timeout").length>0?n.emit("timeout",t,r):t()},this.timeout),this.timers[s]=s),this.results&&(c=this.results.length,this.results[c]=null),this.pending++;var f=r(t);f&&f.then&&"function"==typeof f.then&&f.then(function(e){t(null,e)}).catch(function(e){t(e||!0)}),this.running&&this.jobs.length>0&&this.start()}},m.prototype.stop=function(){this.running=!1},m.prototype.end=function(e){d.call(this),this.jobs.length=0,this.pending=0,b.call(this,e)};var q=w,C=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},A=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),k=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},T=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},P={concurrency:10,timeout:1e4},Q={options:Symbol("options"),requestQueue:Symbol("requestQueue")};return function(e){function t(e,n){C(this,t);var r=T(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r[Q.options]=q(!0,{},P,n),r[Q.requestQueue]=O(q({autostart:!0},r[Q.options])),r}return k(t,e),A(t,[{key:"invoke",value:function(e){var t=this;return new Promise(function(n,r){t[Q.requestQueue].push(function(i){try{n(t.next(e))}catch(e){r(e)}finally{i()}})})}},{key:"config",value:function(e){this[Q.options]=q(!0,this[Q.options],e),this[Q.options].concurrency!==this[Q.requestQueue].concurrency&&(this[Q.requestQueue].concurrency=this[Q.options].concurrency),this[Q.options].timeout!==this[Q.requestQueue].timeout&&(this[Q.requestQueue].timeout=this[Q.options].timeout)}}]),t}(e.Middleware)});
//# sourceMappingURL=index.js.map
